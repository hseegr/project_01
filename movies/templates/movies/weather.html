{% extends "base.html" %}
{% load static %}

{% block content %}

<div class="container weather-search-form">
  <p class="weather-movie-list"><strong class="weather-movie-list-name">{{ user.nickname }}</strong>ë‹˜ì˜ ì„ í˜¸ë„ë¥¼ ê¸°ë°˜ìœ¼ë¡œ, ì˜¤ëŠ˜ ë‚ ì”¨ì— ì–´ìš¸ë¦¬ëŠ” ì˜í™”ë¥¼ ì¶”ì²œí•´ ë“œë¦´ê²Œìš”! ğŸ¥°</p>
  <!-- form action ìˆ˜ì • -->
  <form method="GET">
    <input type="text" name="searched_movies" value="{{ searched_movies }}" placeholder="ì›í•˜ëŠ” ì˜í™”ë¥¼ ê²€ìƒ‰í•´ìš”!">
    <button>ê²€ìƒ‰</button>
  </form>
</div>

<div class="movie-list-container container">
  {% if weather_condition %}
  <p><strong>{{ city }}</strong>ì˜ <strong>{{ korean_weather_description }}</strong> ë‚ ì”¨ì™€ ì–´ìš¸ë¦¬ëŠ” ì˜í™”ëŠ”?</p>
    <p><strong>ì˜¤ëŠ˜ì˜ ì˜¨ë„</strong> : {{ temperature }}Â°C</p>

    {% if user.favorite_genres.all %}
      <p><strong>ì„ í˜¸ ì¥ë¥´</strong> :
        {% for genre in user.favorite_genres.all %}
          {{ genre.name }}{% if not forloop.last %}, {% endif %}
        {% endfor %}
      </p>
    {% endif %}

    <button id="toggleRecommendedButton" class="custom-weather-button">ì¶”ì²œ ì˜í™” ë³´ê¸°</button>

    {% if movies %}
      <div class="movies-container">
        {% for movie in movies %}
          <div class="movie" data-temperature="{{ movie.recommended_temperature|safe }}">
            <div class="poster-with-heart">
              <img class="heart-icon"
                   src="{% static 'img/heart-none.png' %}"
                   alt="icon"
                   data-movie-id="{{ movie.id }}"
                   {% if movie.id in liked_movie_ids %}
                   data-is-liked="true"
                   {% endif %}>
              <div class="poster-overlay"></div>
              <a href="{% url 'movies:movie_detail' movie.id %}">
                <img class="movie-poster" src="https://image.tmdb.org/t/p/w300{{ movie.poster_path }}" alt="{{ movie.title }}">
              </a>
            </div>
            <p class="movie-title">{{ movie.title }}</p>
            <p class="weather-movie-genres">
              {% for genre in movie.genres.all %}
                {{ genre.name }}{% if not forloop.last %}, {% endif %}
              {% endfor %}
            </p>
            {% if movie.is_recommended_for_current_temp %}
              <p class="recommended-badge" style="color:#f439b5; display: none;"><strong>í˜„ì¬ ì˜¨ë„ì— ì¶”ì²œ!</strong></p>
            {% endif %}
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p>ì£„ì†¡í•©ë‹ˆë‹¤. í˜„ì¬ ë‚ ì”¨ì™€ ì„ í˜¸í•˜ì‹œëŠ” ì¥ë¥´ì— ë§ëŠ” ì˜í™”ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
    {% endif %}
  {% else %}
    <p>{{ error }}</p>
  {% endif %}
</div>

<style>
  /* í•˜íŠ¸ ì•„ì´ì½˜ ì• ë‹ˆë©”ì´ì…˜ */
  .heart-icon {
    cursor: pointer;
    transition: transform 0.3s ease;
  }
  
  .heart-icon.bounce {
    animation: bounce 0.5s ease-in-out;
  }
  
  @keyframes bounce {
    0% { transform: scale(1); }
    30% { transform: scale(1.2); }
    50% { transform: scale(1); }
    70% { transform: scale(1.2); }
    100% { transform: scale(1); }
  }
  
  /* ë¯¸ë‹ˆ í•˜íŠ¸ ì• ë‹ˆë©”ì´ì…˜ */
  .mini-heart {
    position: absolute;
    width: 12px;  /* í¬ê¸° ì¡°ì • */
    height: 12px;  /* í¬ê¸° ì¡°ì • */
    animation: float-up 1.5s ease-in-out forwards; /* ì§€ì†ì‹œê°„ 1.5ì´ˆ */
    opacity: 0.8;
  }
  
  @keyframes float-up {
    0% { 
      transform: translate(0, 0) scale(1); 
      opacity: 1; 
    }
    80% { 
      opacity: 0.8; 
    }
    100% { 
      transform: translate(calc(var(--x) * 50px), calc(var(--y) * 100px)) scale(0.8); /* ë¯¸ë‹ˆ í•˜íŠ¸ì˜ í¬ê¸° ë³€í™” */
      opacity: 0; 
    }
  }
</style>


<script>
document.addEventListener('DOMContentLoaded', function () {

  const heartIcons = document.querySelectorAll('.heart-icon');
  const movieContainer = document.querySelector('.movies-container');
  const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
  const allMovies = Array.from(movieContainer.children);

  function createMiniHeart() {
    const miniHeart = document.createElement('img');
    miniHeart.classList.add('mini-heart');
    miniHeart.src = "{% static 'img/heart-fill.png' %}";
    
    const randomX = (Math.random() - 0.5) * 2;
    const randomY = -(Math.random() * 0.5 + 0.5);
    
    miniHeart.style.setProperty('--x', randomX.toString());
    miniHeart.style.setProperty('--y', randomY.toString());
    miniHeart.style.width = '16px';
    miniHeart.style.height = '16px';
    miniHeart.style.opacity = (Math.random() * 0.5 + 0.5).toString();
    
    return miniHeart;
  }

  // ì• ë‹ˆë©”ì´ì…˜ í•¨ìˆ˜
  function animateMovies(movies) {
    movies.forEach(movie => {
      movie.style.opacity = '0';
      movie.style.transform = 'translateY(30px)';
      movie.style.display = 'block';
    });

    setTimeout(() => {
      movies.forEach((movie, index) => {
        movie.style.transition = 'opacity 0.6s, transform 0.6s';
        movie.style.transitionDelay = `${index * 0.15}s`;
        movie.style.opacity = '0.9';
        movie.style.transform = 'translateY(0)';
      });
    },20);
  }

  // ì´ˆê¸° ë¡œë“œ ì‹œ ëª¨ë“  ì˜í™”ì— ì• ë‹ˆë©”ì´ì…˜ ì ìš©
  animateMovies(allMovies);

  // localStorageì—ì„œ ì¢‹ì•„ìš” ìƒíƒœ ë¶ˆëŸ¬ì˜¤ê¸°
  function getLikedMovies() {
    return JSON.parse(localStorage.getItem('likedMovies')) || {};
  }
  
  // localStorageì— ì¢‹ì•„ìš” ìƒíƒœ ì €ì¥í•˜ê¸°
  function saveLikedMovies(likedMovies) {
    localStorage.setItem('likedMovies', JSON.stringify(likedMovies));
  }
  
  // ì´ˆê¸° ìƒíƒœ ì„¤ì •
  function initializeHeartIcons() {
    const likedMovies = getLikedMovies();
    heartIcons.forEach(icon => {
      const movieId = icon.dataset.movieId;
      if (likedMovies[movieId]) {
        icon.src = "{% static 'img/heart-fill.png' %}";
        icon.dataset.isLiked = "true";
      } else {
        icon.src = "{% static 'img/heart-none.png' %}";
        icon.dataset.isLiked = "false";
      }
    });
  }
  
  // ì´ˆê¸°í™” ì‹¤í–‰
  initializeHeartIcons();
  
  // í´ë¦­ ì´ë²¤íŠ¸ ì²˜ë¦¬ -> ì¢‹ì•„ìš”, ì¢‹ì•„ìš” í•´ì œ
  movieContainer.addEventListener('click', function (event) {
    if (!event.target.classList.contains('heart-icon')) return;

    event.preventDefault();

    // ë¹„ë¡œê·¸ì¸ ìƒíƒœì—ì„œ í•˜íŠ¸ í´ë¦­ ì‹œ, ì•ŒëŸ¿ + ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™
    if (!isUserLoggedIn) {
      alert('ë¡œê·¸ì¸ì´ í•„ìš”í•œ í˜ì´ì§€ì…ë‹ˆë‹¤. ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.')
      window.location.href = "{% url 'accounts:login' %}"
      return
    }

    const movieId = event.target.dataset.movieId;

    // í†µí†µ íŠ€ëŠ” ì• ë‹ˆë©”ì´ì…˜ ì¶”ê°€
    event.target.classList.add('bounce');

    // ì• ë‹ˆë©”ì´ì…˜ì´ ëë‚œ í›„ í´ë˜ìŠ¤ ì œê±°
    event.target.addEventListener('animationend', function() {
      event.target.classList.remove('bounce');
    });

    


    axios({
      method: 'post',
      url: `/movies/${movieId}/likes/`,
      headers: { 'X-CSRFToken': csrftoken },
    })
      .then((response) => {
        const isLiked = response.data.is_liked;
        event.target.src = isLiked
          ? "{% static 'img/heart-fill.png' %}"
          : "{% static 'img/heart-none.png' %}";
        event.target.dataset.isLiked = isLiked.toString();

        // localStorage ì—…ë°ì´íŠ¸
        const likedMovies = getLikedMovies();
        if (isLiked) {
          likedMovies[movieId] = true;
        } else {
          delete likedMovies[movieId];
        }
        saveLikedMovies(likedMovies);
      })
      .catch((error) => {
        console.log(error);
      });
  });

   const toggleRecommendedButton = document.getElementById('toggleRecommendedButton');
   let isRecommendedVisible = false;

   toggleRecommendedButton.addEventListener('click', function() {
     isRecommendedVisible = !isRecommendedVisible;

     // Hide all movies immediately
     allMovies.forEach(movie => {
       movie.style.display = 'none';
     });

     // Delay for a second before showing movies again
     setTimeout(() => {
       const visibleMovies = [];

       allMovies.forEach(movie => {
         const badge = movie.querySelector('.recommended-badge');
         if (isRecommendedVisible) {
           if (badge) {
             visibleMovies.push(movie);
             movie.style.display = 'block'; // Show recommended movies
           }
         } else {
           visibleMovies.push(movie);
           movie.style.display = 'block'; // Show all movies
         }

         if (badge) {
           badge.style.display = isRecommendedVisible ? 'block' : 'none';
         }
       });

       // Apply animation to the visible movies after the delay
       animateMovies(visibleMovies);
     }, 1000); // Delay of one second

     this.textContent = isRecommendedVisible ? 'ëª¨ë“  ì˜í™” ë³´ê¸°' : 'ì¶”ì²œ ì˜í™” ë³´ê¸°';
   });
});
</script>

{% endblock %}